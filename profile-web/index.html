<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-a37c72dd2dbac68997fcdc15a3622e78.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<link href="https://fonts.googleapis.com/css2?family=Open+Sans&amp;display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Open Sans', sans-serif;
  }
</style>
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="header_section" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="country_summary" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="classifications" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="survey_charts" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="concepts_standards" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="nso_info" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="other_resources" class="shiny-html-output"></div>
</div>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
library(shiny)
library(dplyr)
library(magrittr)
library(tidyr)
library(readxl)
library(htmltools)
library(leaflet)
library(plotly)
library(htmlwidgets)
library(sf)
library(leaflet.extras2)


# Load data
df <- read.csv("input.csv", stringsAsFactors = FALSE) %>%
  arrange(short_name)

# Region label and color mapping
region_names <- list(
  "NAC" = "North America",
  "LCN" = "Latin America & Caribbean",
  "ECS" = "Europe & Central Asia",
  "EAS" = "East Asia & Pacific",
  "SAS" = "South Asia",
  "MEA" = "Middle East & North Africa",
  "SSF" = "Sub-Saharan Africa"
)

# Colors based on WB visualization guide (https://wbg-vis-design.vercel.app/colors)
region_colors <- list(
  "NAC" = "#34A7F2", "SSF" = "#FF9800", "MEA" = "#664AB6", "SAS" = "#4EC2C0",
  "EAS" = "#F3578E", "LCN" = "#0C7C68", "ECS" = "#AA0000"
)

# Income group label and color mapping
income_names <- list(
  "HIC" = "High Income",
  "UMC" = "Upper Middle Income",
  "LMC" = "Lower Middle Income",
  "LIC" = "Low Income",
  "NA" = "Not classified"
)

income_colors <- list(
  "HIC" = "#016B6C",
  "UMC" = "#73AF48",
  "LMC" = "#DB95D7",
  "LIC" = "#3B4DA6",
  "NA" = "#CED4DE"
)

# Lending group label and color mapping
lending_names <- list(
  "IBRD" = "IBRD",
  "IDA" = "IDA",
  "Blend" = "Blend of IBRD and IDA",
  "NA" = "Not classified"
)

lending_colors <- list(
  "IBRD" = "#0169A1",
  "IDA" = "#089BD4",
  "Blend" = "#75CCEC",
  "NA" = "#CED4DE"
)

# Load GeoJSON
geojson_data <- st_read("www/wb_admin0_wgs84_geo.json", quiet = TRUE)

</script>
 
<script type="application/shiny-prerendered" data-context="server">
# Shared reactive
country_data <- reactive({
  req(input$country)
  dplyr::filter(df, short_name == input$country)
})

# ---------------- Header section ---------------------------------------------
output$header_section <- renderUI({
  tagList(
    div(
      style = "display: flex; justify-content: space-between; align-items: flex-start; margin-top: 0px; margin-bottom: 10px;",

      # country selector
      selectInput("country", HTML("&#128205; Choose an economy"),
                  choices = unique(df$short_name),
                  selected = unique(df$short_name)[1],
                  width = "300px")
    ),

    # Divider line
    tags$hr(style = "margin-top: 15px; margin-bottom: 40px; border: none; border-top: 1px solid #999;")
  )
})

# ---------------- Summary section ---------------------------------------------
output$country_summary <- renderUI({
  d <- country_data()
  req(nrow(d) > 0) 

  getval <- function(x) {
    val <- d[[x]][1]
    if (is.null(val) || is.na(val) || val == "") "Not available" else val
  }

  div(
     style = "display: flex; flex-wrap: wrap; gap: 30px; margin-top: 30px; align-items: flex-start;",

    # Left side: basic country info text
    div(
      style = "flex: 1; min-width: 300px;",
      div(style = "font-size: 35px; font-weight: 900; margin-top:20px; margin-bottom:20px;", getval("short_name")),
      div(style = "font-size: 15px; line-height: 1;",
          tags$p(style = "margin: 0 0 10px 0;","Long name: ", tags$b(getval("long_name"))),
          tags$p(style = "margin: 0 0 10px 0;","Economy code: ", tags$b(getval("iso3c"))),
          tags$p(style = "margin: 0 0 10px 0;","ISO-2 code: ", tags$b(getval("iso2c"))),
          tags$p(style = "margin: 0 0 10px 0;","WB-2 code: ", tags$b(getval("wb2code"))),
          tags$p(style = "margin: 0 0 10px 0;","Capital city: ", tags$b(getval("capital_city"))),
          tags$p(style = "margin: 0 0 10px 0;",
                 "Latitude & longitude of capital city: ",tags$b(paste0(getval("latitude"), ", ", getval("longitude"))))
          )
      ),

    # Right side: map + download link
div(div(
  style = "flex: 1; min-width: 300px; max-width: 350px;",
  leafletOutput("map", height = "250px"),
  div(
    style = "text-align: right; margin-top: 8px;",
    tags$a(
      href = "https://datacatalog.worldbank.org/int/search/dataset/0038272/World-Bank-Official-Boundaries", target = "_blank",
      style = "font-size: 12px; color: #888; text-decoration: none;",
      tags$img(src = "www/download-minimalistic.svg", height = "12px", style = "vertical-align: text-bottom; margin-right: 4px;"),
      "Download economy boundaries"
    ))
)
)
  )
})

# Map section
output$map <- renderLeaflet({
  d <- country_data()
  req(nrow(d) > 0)

  lat <- suppressWarnings(as.numeric(d$latitude[1]))
  lon <- suppressWarnings(as.numeric(d$longitude[1]))
  capital <- d$capital_city[1]
  iso3 <- d$iso3c[1]

  disputed <- geojson_data %>% filter(ISO_A2 == "-99")
  regular <- geojson_data %>% filter(ISO_A2 != "-99")
  selected_country <- geojson_data %>% filter(ISO_A3 == iso3)

  map <- leaflet(options = leafletOptions(minZoom = 2, maxZoom = 6)) %>%
    addPolygons(
      data = regular,
      weight = 0.5,
      color = "#666666",
      fillOpacity = 0.1,
      label = ~WB_ADM0_NA,
      group = "Regular"
    ) %>%
    addPolygons(
      data = disputed,
      weight = 1,
      color = "#666666",
      dashArray = "3,3",
      fillOpacity = 0.1,
      label = ~WB_ADM0_NA,
      group = "Disputed"
    ) %>%
    addPolygons(
      data = selected_country,
      weight = 2,
      color = "#0071BC",
      fillOpacity = 0.3,
      label = ~WB_ADM0_NA,
      group = "Selected"
    )

  # Add view + marker
  if (!is.na(lat) && !is.na(lon)) {
    map <- map %>%
      setView(lng = lon, lat = lat, zoom = 3) %>%
      addMarkers(lng = lon, lat = lat, popup = capital)
  } else {
    map <- map %>% setView(lng = 0, lat = 20, zoom = 2)
  }

  map
})


# --------------- World Bank classifications section --------------------------
output$classifications <- renderUI({
  d <- country_data()
  req(nrow(d) > 0)
  getval <- function(x) {
    val <- d[[x]][1]
    if (is.null(val) || is.na(val) || val == "") "Not available" else val
  }

  # Extract values
  region_name <- getval("region")
  region_code <- getval("region_iso3c")
  region_color <- region_colors[[region_code]]
  if (is.null(region_color)) region_color <- "#888"

  income_code <- getval("income_level_iso3c")
  income_name <- if (!is.null(income_names[[income_code]])) income_names[[income_code]] else income_code

  lending_selected <- as.character(getval("lending_type"))

 # Section style 
  div(
    style = "margin-top: 30px;",
    # Header text and divider line
    div(
      style = "font-size: 18px; font-weight: 600; color: #111111; margin-bottom: 10px;","World Bank Classifications"),
    tags$hr(style = "margin-top: 3px; margin-bottom: 10px; border: none; border-top: 1px solid #999;"),

    # Row with 3 cards
    div(
      style = "display: flex; gap: 20px; flex-wrap: wrap;",

      # 1) Region card
      div(
        style = "flex: 1; min-width: 220px; border: 0px; padding: 15px;",
        tags$p(
          tags$span(
            style = "color: #111111; font-size: 14px; display: block;",
            "Region"
            # HTML("Region &#128279;")
            ),
          tags$span(
            style = paste0("font-size: 15px; font-weight: 600; color: ", region_color, "; display: block;"),
            region_name
            )
          ),
        div(
          style = "margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;",
          lapply(names(region_colors), function(code) {
            is_active <- code == region_code
            color <- region_colors[[code]]
            full_label <- if (!is.null(region_names[[code]])) region_names[[code]] else code

            tile_style <- paste0(
              "width: 42px; height: 42px; border: 1px solid ", color, "; ",
              "color: ", color, "; ",
              "display: flex; align-items: center; justify-content: center; ",
              "font-size: 13px; font-weight: ", if (is_active) "700;" else "400;",
              if (is_active) paste0(" background-color: ", color, "; color: white; box-shadow: 0 0 2px #000;") 
              else " background-color: transparent;"
              )

            div(
              title = full_label,
              style = tile_style,
              code
            )
          })
        )
      ),

      # 2) Income group card
      div(
        style = "flex: 1; min-width: 220px; border: 0px; padding: 15px;",
        tags$p(
          tags$span(
            style = "color: #111111; font-size: 14px; display: block;",
             "Income Group"
            ),
          tags$span(
            style = paste0("font-size: 15px; font-weight: 600; color: ", income_colors[[income_code]], "; display: block;"),
            income_name
            )
          ),
        div(
          style = "margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;",
          lapply(names(income_colors), function(code) {
            is_active <- code == income_code
            color <- income_colors[[code]]

            tile_style <- paste0(
              "width: 42px; height: 42px; border: 1px solid ", color, "; ",
              "color: ", color, "; ",
              "display: flex; align-items: center; justify-content: center; ",
              "font-size: 13px; font-weight: ", if (is_active) "700;" else "400;",
              if (is_active) paste0(" background-color: ", color, "; color: white; box-shadow: 0 0 2px #000;") 
              else " background-color: transparent;"
              )
            
            div(
              title = income_names[[code]],
              style = tile_style,
              code
            )
          })
        )
      ),

      # 3) Lending category care
      div(
        style = "flex: 1; min-width: 220px; border: 0px; padding: 15px;",
        tags$p(
          tags$span(style = "color: #111111; font-size: 14px; display: block;", 
                    "Lending Category"
                    ),
          tags$span(
            style = "font-size: 15px; font-weight: 600; color: #0071BC; display: block;",
            if (!is.null(lending_names[[lending_selected]])) lending_names[[lending_selected]] else lending_selected
            )
          ),
        div(
          style = "margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;",
          lapply(names(lending_colors), function(code) {
            is_active <- code == lending_selected
            color <- lending_colors[[code]]
            label <- if (!is.null(lending_names[[code]])) lending_names[[code]] else code
            
            tile_style <- paste0(
              "width: 42px; height: 42px; border: 1px solid ", color, "; ",
              "color: ", color, "; ",
              "display: flex; align-items: center; justify-content: center; ",
              "font-size: 13px; font-weight: ", if (is_active) "700;" else "400;",

              if (is_active) paste0(" background-color: ", color, "; color: white; box-shadow: 0 0 2px #000;") 
              else " background-color:transparent;"
              )
            div(
              title = label,
              style = tile_style,
              code
              )
            })
          )
        )
      ),
    tags$p(
      style = "font-size: 13px; color: #666; margin-top: 15px;",
      "For historical data, see the ",
      tags$a(
        href = "https://datacatalogfiles.worldbank.org/ddh-published/0037712/DR0094546/CLASS_hist.xlsx",
        target = "_blank",
        style = "color: #0071BC; text-decoration: none;",
        "historical classifications file."
        )
      )

    )
  })

# --------------- Most recent core censuses and surveys section ----------------
output$survey_charts <- renderUI({
  d <- country_data()
  req(nrow(d) > 0)

  survey_fields <- list(
    popu = list(label1 = "Population & Housing census", col1 = "cen_popu",
                label2 = "Health/Demographic survey", col2 = "svy_hlth", icon = "www/people_poverty-and-equity.svg"),
    agri = list(label1 = "Agriculture census", col1 = "cen_agri",
                label2 = "Agriculture survey", col2 = "svy_agri", icon = "www/agriculture-and-food.svg"),
    bizz = list(label1 = "Business/establishment census", col1 = "cen_bizz",
                label2 = "Business/establishment survey", col2 = "svy_bizz", icon = "www/business_private-sector-development.svg"),
    hous = list(label1 = "Household Survey on income/consumption/etc.", col1 = "svy_hous",
                label2 = "Labor Force Survey", col2 = "svy_labr", icon = "www/financial-sector-development.svg")
  )

  rows <- lapply(survey_fields, function(info) {
    icon_box <- div(
      style = "flex: 0 0 40px; display: flex; align-items: flex-start; padding-top: 5px;",
      tags$img(src = info$icon, height = "25px")
    )

    chart_col <- function(label, colname) {
      val <- d[[colname]][1]
      year_txt <- ifelse(is.na(val), "Not available", as.character(val))

      div(
        style = "flex: 1; min-width: 300px;",
        div(style = "font-weight: 600; font-size: 14px; margin-bottom: 4px;", label),
        plotly::plotlyOutput(paste0("line_", colname), height = "50px", width = "350px")
      )
    }

    div(
      style = "display: flex; gap: 20px; margin-bottom: 25px;",
      icon_box,
      chart_col(info$label1, info$col1),
      chart_col(info$label2, info$col2)
    )
  })

  div(
     style = "margin-top: 40px;",
      div("Most Recent Core Censuses and Surveys",
        style = "font-size: 18px; font-weight: 600; color: #111; margin-bottom: 7px;"),
          tags$hr(style = "margin: 3 0 15px 0; border: none; border-top: 1px solid #999;"),
    div(rows)
    )
  })

observe({
  d <- country_data()

  fields <- c("cen_popu", "svy_hlth", "cen_agri", "svy_agri",
              "cen_bizz", "svy_bizz", "svy_hous", "svy_labr")

  year_values <- suppressWarnings(as.numeric(unlist(d[fields])))
  year_values <- year_values[!is.na(year_values)]

  # Base consistent range - to be adjusted once all country data is ready
  global_min <- 1995
  global_max <- 2024

  # Expand only if needed
  year_min <- min(c(global_min, year_values), na.rm = TRUE)
  year_max <- max(c(global_max, year_values), na.rm = TRUE)

  range_buffer <- 1
  year_min_padded <- year_min - range_buffer
  year_max_padded <- year_max + range_buffer

  for (field in fields) {
    local({
      f <- field
      yr <- as.numeric(d[[f]][1])
      year_label <- ifelse(is.na(yr), "Not available", as.character(yr))

      output[[paste0("line_", f)]] <- plotly::renderPlotly({
  base <- plot_ly() %>%
    add_segments(
      x = year_min, xend = year_max, y = 0, yend = 0,
      line = list(color = "#e0e0e0", width = 6),
      showlegend = FALSE, hoverinfo = "none"
    )

  if (is.na(yr)) {
    base %>%
      # Invisible marker
      add_markers(
        x = (year_min_padded + year_max_padded) / 2,
        y = 0,
        marker = list(opacity = 0, size = 8),
        hoverinfo = "none",
        showlegend = FALSE
      ) %>%
      # Placeholder text annotation (invisible)
      add_text(
        x = (year_min_padded + year_max_padded) / 2,
        y = 0.1,
        text = "",
        textfont = list(size = 12, color = "#666", family = "Open Sans"),
        hoverinfo = "none",
        showlegend = FALSE
      ) %>%
      # Not available annotation
      add_annotations(
        text = "<span style='font-weight: normal;'>Not available<\u002fspan>",
        x = (year_min_padded + year_max_padded) / 2,
        y = 0,
        yanchor = "middle",
        showarrow = FALSE,
        font = list(size = 12, color = "#666")
      ) %>%
      layout(
        dragmode = FALSE,
        xaxis = list(
          range = c(year_min_padded - 1, year_max_padded + 1),
          showticklabels = TRUE,
          showgrid = FALSE,
          tickfont = list(size = 11, color = "#444", family = "Open Sans")
        ),
        yaxis = list(range = c(-0.1, 0.3), visible = FALSE, fixedrange = TRUE),
        margin = list(l = 0, r = 0, t = 0, b = 0)
      ) %>%
      config(displayModeBar = FALSE, staticPlot = TRUE)

  } else {
    base %>%
      add_markers(
        x = yr, y = 0,
        marker = list(color = "#0071BC", size = 10, symbol = "circle"),
        hoverinfo = "none",
        showlegend = FALSE
      ) %>%
      add_text(
        x = yr, y = 0.1,
        text = year_label,
        textposition = "top center",
        textfont = list(color = "#0071BC", size = 12, family = "Open Sans"),
        hoverinfo = "none",
        showlegend = FALSE
      ) %>%
      layout(
        dragmode = FALSE,
        hovermode = FALSE,
        xaxis = list(
          range = c(year_min_padded - 1, year_max_padded + 1),
          showticklabels = TRUE,
          showgrid = FALSE,
          tickfont = list(size = 11, color = "#444", family = "Open Sans")
        ),
        yaxis = list(range = c(-0.1, 0.3), visible = FALSE, fixedrange = TRUE),
        margin = list(l = 0, r = 0, t = 0, b = 0)
      ) %>%
      config(displayModeBar = FALSE, staticPlot = TRUE)
  }
})
      })
    }
  })

# --------------- Statistical concepts and data standards section --------------
output$concepts_standards <- renderUI({
  d <- country_data()
  req(nrow(d) > 0)
  getval <- function(x) {
    val <- d[[x]][1]
    if (is.null(val) || is.na(val) || val == "") "Not available" else val
    }

concepts <- list(
  "Balance Of Payments Manual in use"="bop_imf",
  "IMF data dissemination standard" = "standard_imf",
  "System of National Accounts in use" = "system_na",
  "National Accounts base year" = "baseyr_na",
  "Classification of national industry" = "classif_industry",
  "CPI base year" = "cpi_year",
  "Classification of household consumption" = "classif_hh_consump",
  "Classification of status of employment" = "classif_emp",
  "Central government accounting status" = "status_account",
  "Compilation of government finance statistics" = "compil_finance",
  "Compilation of monetary and financial statistics" = "compil_monetary",
  "Business process" = "bizz_process"
)

rows <- lapply(names(concepts), function(label) {
  colname <- concepts[[label]]
  value <- getval(colname)
  
  tags$tr(
        tags$td(
      title = switch(label,
                     "Balance Of Payments Manual in use" = "IMF's Balance of Payments Manual (BPM) provides standards for concepts, definitions, and classifications for international accounts statistics.",
                     "IMF data dissemination standard" = "IMF's Data Dissemination Standards-e-GDDS, SDDS, and SDDS Plus-provide frameworks that guide member countries in publishing economic and financial data outlining requirements for data frequency, coverage, and metadata.",
                     "System of National Accounts in use" = "The national accounts data are compiled using the concepts, definitions, framework, and methodology of the System of National Account 2008 (SNA2008) or European System of National and Regional Accounts (ESA 2010).",
                     "National Accounts base year" = "National accounts base year is the year used as the base period for constant price calculations in the country's national accounts.",
                     "Classification of national industry" = "The industrial production data are compiled using the International Standard Industrial Classification of All Economic Activities (ISIC) and Statistical Classification of Economic Activities in the European Community (NACE)",
    "CPI base year" = "Consumer Price Index (CPI) serves as indicators of inflation and reflects changes in the cost of acquiring a fixed basket of goods and services by the average consumer. Weights are usually derived from consumer expenditure surveys and the CPI base year refers to the year the weights were derived.",
    "Classification of household consumption" = "Classification of Individual Consumption According to Purpose (COICOP) is used in household budget surveys, consumer price indices and international comparisons of gross domestic product (GDP) and its component expenditures.",
    "Classification of status of employment" = "Classification of status of employment refers to employment data that are compiled using the current international standard International Classification of Status in Employment (ISCE-93).",
    "Central government accounting status" = "Government finance accounting status refers to the accounting basis for reporting central government financial data.",
    "Compilation of government finance statistics" = "Compilation of government finance statistics refers to Government Finance Statistics Manual (GFSM) in use for compiling the data.",
    "Compilation of monetary and financial statistics" = "Compilation of monetary and financial statistics refers to the Monetary and Financial Statistics Manual (MFSM) in use.",
    "Business process" = "Business process refers to the Generic Statistical Business Process Model (GSBPM) in use.",
    NULL
  ),
  style = "padding: 4px 12px 4px 0; vertical-align: top; color: #333;",
  label
),
    tags$td(tags$b(style = "font-weight: 600; color: #111;", value))
    )
  })

div(
  style = "margin-top: 40px;",
  
  # Section title
  div(
    style = "font-size: 18px; font-weight: 600; color: #111111; margin-bottom: 10px;",
    "Statistical Concepts and Data Standards"
  ),
  
  # Divider
  tags$hr(style = "margin: 0 0 15px 0; border: none; border-top: 1px solid #999;"),
  
  # Table
  tags$table(
    style = "font-size: 14px; border-spacing: 0px;",
    rows
  ),
  
  # Note text with links
tags$p(
  style = "font-size: 13px; color: #666; margin-top: 15px;",
  "For more details, see the ",
  tags$a(
    href = "https://documents1.worldbank.org/curated/en/815721616086786412/pdf/Measuring-the-Statistical-Performance-of-Countries-An-Overview-of-Updates-to-the-World-Bank-Statistical-Capacity-Index.pdf", 
    target = "_blank", style = "color: #0071BC; text-decoration: none;", 
    "SPI Technical Note,"
  ),
  " ",
  tags$a(
    href = "https://www.imf.org/en/About/Factsheets/Sheets/2023/Standards-for-data-dissemination", 
    target = "_blank", style = "color: #0071BC; text-decoration: none;", 
    "IMF Data Standards"
  ),
  " and ",
  tags$a(
    href = "https://www.imf.org/en/Publications/Manuals-Guides/Issues/2016/12/31/Balance-of-Payments-Manual-Sixth-Edition-22588", 
    target = "_blank", style = "color: #0071BC; text-decoration: none;", 
    "IMF Manuals & Guides."
  )
)
)

})

# --------------- National Statistics Office section --------------------------
output$nso_info <- renderUI({
  d <- country_data()
  req(nrow(d) > 0)
  
  getval <- function(x) {
    val <- d[[x]][1]
    if (is.null(val) || is.na(val) || val == "") "Not available" else val
  }

  nso_name <- getval("nso_name")
  nso_uri <- getval("nso_uri")

  div(
    style = "margin-top: 40px;",
    tags$a(name = "nso"),
    div("National Statistics Office",
        style = "font-size: 18px; font-weight: 600; color: #111; margin-bottom: 10px;"),
    tags$hr(style = "margin: 0 0 15px 0; border: none; border-top: 1px solid #999;"),
    tags$table(
      style = "font-size: 14px; border-spacing: 0px;",
      tags$tr(
        tags$td(style = "padding: 4px 12px 4px 0; vertical-align: top; font-weight: 600; color: #111;", nso_name),
        tags$td(
          style = "font-size: 14px; padding: 4px 0;",
          if (!is.null(nso_uri) && nso_uri != "" && nso_uri != "Not available") {
            url <- if (grepl("^https?://", nso_uri)) nso_uri else paste0("https://", nso_uri)
            tags$a(
              href = url, target = "_blank",
              style = "text-decoration: none; color: #0071BC;",
              HTML("&#128279; "), 
              gsub("^https?://", "", url)
              )} else {
                "Not available"
                }
        )
      )
    )
  )
})


# --------------- Other resources section --------------------------------------
output$other_resources <- renderUI({
  d <- country_data()
  req(nrow(d) > 0)

  getval <- function(x) {
    val <- d[[x]][1]
    if (is.null(val) || is.na(val) || val == "") "Not available" else val
  }
  
  wb_url <- getval("wb_uri")
  spi_gap_url <- getval("spi_gap_url")

  resources <- list(
    "Statistical Performance Indicators (SPI)" = "https://www.worldbank.org/en/programs/statistical-performance-indicators",
    "SPI economy report" = "https://github.com/worldbank/SPI/tree/master/country_reports",
    # "SPI data gap assessment profile" = {
    #   if (!is.null(spi_gap_url) && spi_gap_url != "" && spi_gap_url != "Not available") {
    #     if (grepl("^https?://", spi_gap_url)) {
    #       spi_gap_url
    #       } else {
    #         paste0("https://", spi_gap_url)
    #         }
    #     } else {
    #       NA
    #       }},
    "Poverty and equity briefs" = "https://www.worldbank.org/en/topic/poverty/publication/poverty-and-equity-briefs",
    "WDI data quality dashboard" = "https://wb-decis.github.io/wdi_indicator_monitor-public/wdi_monitor.html",
    "World Bank economy page" = {
      if (!is.null(wb_url) && wb_url != "" && wb_url != "Not available") {
        if (grepl("^https?://", wb_url)) {
          wb_url
          } else {
            paste0("https://", wb_url)
            }
        } else {
          NA
        }
      }
    )
  
rows <- lapply(names(resources), function(label) {
  uri <- resources[[label]]
  
  link_cell <- if (!is.na(uri)) {
    tags$a(
      href = uri, target = "_blank",
      style = "text-decoration: none; color: #0071BC;",
      HTML("&#128279; "), 
      sub("^https?://", "", uri)
    )
  } else {
    "Not available"
  }
  
  tags$tr(
    tags$td(style = "padding: 4px 12px 4px 0; vertical-align: top; font-weight: 600; color: #111;", label),
    tags$td(style = "font-size: 14px; padding: 4px 0;", link_cell)
  )
})

  div(
    style = "margin-top: 40px;",
    div("Other Resources",
        style = "font-size: 18px; font-weight: 600; color: #111; margin-bottom: 10px;"),
    tags$hr(style = "margin: 0 0 15px 0; border: none; border-top: 1px solid #999;"),
    tags$table(
      style = "font-size: 14px; border-spacing: 0px;",
      rows
    )
  )
})
</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(
    function(q, nm, val) {
      # Infer name, if possible
      if (nm == "") {
        tryCatch(
          {
            nm <- rlang::as_name(q)
          },
          error = function(e) {
            code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
            stop(
              "ojs_define() could not create a name for the argument: ",
              code
            )
          }
        )
      }
      .session$output[[nm]] <- val
      outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
      .session$sendCustomMessage("ojs-export", list(name = nm))
      NULL
    },
    quos,
    nm,
    vars,
    SIMPLIFY = FALSE,
    USE.NAMES = FALSE
  )
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69]}},"value":[{"type":"character","attributes":{},"value":["base","cellranger","class","classInt","cli","colorspace","compiler","crosstalk","data.table","datasets","DBI","digest","dplyr","e1071","evaluate","fansi","fastmap","generics","ggplot2","glue","graphics","grDevices","grid","gtable","htmltools","htmlwidgets","httpuv","httr","jsonlite","KernSmooth","knitr","later","lazyeval","leaflet","leaflet.extras2","lifecycle","magrittr","methods","mime","munsell","pillar","pkgconfig","plotly","promises","proxy","purrr","R6","Rcpp","readxl","rlang","rmarkdown","rstudioapi","scales","sf","shiny","stats","tibble","tidyr","tidyselect","tools","units","utf8","utils","vctrs","viridisLite","withr","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.4.1","1.1.0","7.3-22","0.4-10","3.6.3","2.1-1","4.4.1","1.2.1","1.16.2","4.4.1","1.2.3","0.6.37","1.1.4","1.7-16","1.0.1","1.0.6","1.2.0","0.1.3","3.5.1","1.8.0","4.4.1","4.4.1","4.4.1","0.3.6","0.5.8.1","1.6.4","1.6.15","1.4.7","1.8.9","2.23-24","1.49","1.3.2","0.2.2","2.2.2","1.3.1","1.0.4","2.0.3","4.4.1","0.12","0.5.1","1.9.0","2.0.3","4.10.4","1.3.0","0.4-27","1.0.2","2.5.1","1.0.13-1","1.4.3","1.1.4","2.29","0.17.1","1.3.0","1.0-20","1.9.1","4.4.1","3.2.1","1.3.1","1.2.1","4.4.1","0.8-7","1.2.4","4.4.1","0.6.5","0.4.2","3.0.2","0.49","1.8-4","2.3.10"]}]}]}
</script>
<!--/html_preserve-->

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>